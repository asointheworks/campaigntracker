<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waterdeep: Dragon Heist - Campaign Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <div class="dragon-icon">üêâ</div>
                <div class="title-group">
                    <h1>Waterdeep: Dragon Heist (Remix)</h1>
                    <span class="subtitle">A Humble Campaign Tracker</span>
                </div>
            </div>
            <nav class="main-nav">
                <button class="nav-btn active" data-section="dashboard">
                    <span class="nav-icon">üè∞</span> Dashboard
                </button>
                <button class="nav-btn" data-section="party">
                    <span class="nav-icon">‚öîÔ∏è</span> Characters!
                </button>
                <button class="nav-btn" data-section="pc-tales">
                    <span class="nav-icon">üìú</span> PC Tales!
                </button>
                <button class="nav-btn" data-section="campaign-notes">
                    <span class="nav-icon">üìñ</span> Campaign Notes
                </button>
                <button class="nav-btn" data-section="initiative">
                    <span class="nav-icon">‚ö°</span> Initiative
                </button>
                <button class="nav-btn" data-section="rules">
                    <span class="nav-icon">‚öñÔ∏è</span> Rules
                </button>
                <button class="nav-btn" data-section="gallery">
                    <span class="nav-icon">üé®</span> Gallery
                </button>
            </nav>
            <div class="sync-status" id="sync-status" title="Firebase sync status">
                <span class="sync-icon" id="sync-icon">&#9679;</span>
                <span class="sync-text" id="sync-text">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="section-header">
                <h2>Campaign Dashboard</h2>
                <p class="section-subtitle">Welcome to the City of Splendors</p>
            </div>

            <div class="dashboard-grid">
                <!-- Campaign Overview Card -->
                <div class="card campaign-overview">
                    <div class="card-header">
                        <h3 id="campaign-name-display">üìç Campaign Overview</h3>
                        <button class="btn btn-small" onclick="openCampaignEditModal()">Edit</button>
                    </div>
                    <div class="card-content">
                        <div class="campaign-image" id="campaign-image-container">
                            <img id="campaign-image" src="" alt="Campaign Image" style="display:none; width:100%; height:100%; object-fit:cover; border-radius: var(--border-radius);">
                            <div class="d20-placeholder" id="campaign-d20-placeholder">
                                <svg viewBox="0 0 100 100" class="d20-icon">
                                    <polygon points="50,5 95,30 95,70 50,95 5,70 5,30" fill="none" stroke="currentColor" stroke-width="2"/>
                                    <polygon points="50,5 95,30 50,50 5,30" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                    <polygon points="95,30 95,70 50,50" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                    <polygon points="95,70 50,95 50,50" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                    <polygon points="50,95 5,70 50,50" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                    <polygon points="5,70 5,30 50,50" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                    <text x="50" y="58" text-anchor="middle" font-size="20" font-weight="bold" fill="currentColor">20</text>
                                </svg>
                            </div>
                            <div class="image-overlay">
                                <span class="location-badge" id="location-badge">The High Road</span>
                            </div>
                        </div>
                        <div class="campaign-details">
                            <div class="detail-item">
                                <span class="detail-label">Current Chapter</span>
                                <span class="detail-value" id="current-chapter">Chapter 1: Along the High Road</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Session Number</span>
                                <span class="detail-value" id="session-number">Session 1</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Party Level</span>
                                <span class="detail-value" id="party-level-display">Level 3</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Current Location</span>
                                <span class="detail-value" id="current-location">The High Road</span>
                            </div>
                        </div>
                        <!-- XP Progress Bar -->
                        <div class="xp-progress-section">
                            <div class="xp-header">
                                <span class="xp-label">Experience Points</span>
                                <span class="xp-value" id="xp-display">450 / 2,700 XP</span>
                            </div>
                            <div class="xp-bar">
                                <div class="xp-fill" id="xp-fill" style="width: 16.7%"></div>
                            </div>
                            <span class="xp-hint" id="xp-hint">2,250 XP needed for Level 4</span>
                        </div>
                    </div>
                </div>

                <!-- Next Session -->
                <div class="card next-session">
                    <div class="card-header">
                        <h3>üìÖ Next Session</h3>
                    </div>
                    <div class="card-content">
                        <div class="session-info">
                            <input type="datetime-local" id="next-session-date" class="session-date-input">
                            <textarea id="session-notes" placeholder="Session prep notes..." class="session-notes"></textarea>
                            <button class="btn btn-primary" onclick="saveSessionInfo()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Campaign Synopsis -->
                <div class="card synopsis full-width">
                    <div class="card-header">
                        <h3>üìö Campaign Synopsis</h3>
                        <button class="btn btn-small" onclick="toggleEditSynopsis()">Edit</button>
                    </div>
                    <div class="card-content">
                        <div id="synopsis-display" class="synopsis-text">
                            <p><strong>Waterdeep: Dragon Heist</strong> is a treasure hunt set against an urban backdrop of one of D&D's most iconic cities. A massive treasure hoard of half a million gold dragons has been hidden somewhere in the city by the legendary Lord Neverember, and now factions vie for control of this legendary fortune.</p>
                            <p>Our heroes find themselves drawn into this conflict, starting with a simple rescue mission at the Yawning Portal tavern. Little do they know that their actions will set them on a collision course with some of Waterdeep's most dangerous villains.</p>
                            <p><em>This homebrewed version incorporates the updated D&D 2024 rules, expanded faction interactions, and additional character-driven storylines.</em></p>
                        </div>
                        <div id="synopsis-edit" class="synopsis-edit hidden">
                            <div class="rich-editor" id="synopsis-editor">
                                <div class="editor-toolbar">
                                    <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                    <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                    <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                    <span class="toolbar-divider"></span>
                                    <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                    <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                    <span class="toolbar-divider"></span>
                                    <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    <button type="button" onclick="formatText('formatBlock', 'blockquote')" title="Quote">"</button>
                                </div>
                                <div class="editor-content synopsis-editor-content" id="synopsis-textarea" contenteditable="true" data-placeholder="Write your campaign synopsis..."></div>
                            </div>
                            <div class="edit-actions">
                                <button class="btn btn-primary" onclick="saveSynopsis()">Save</button>
                                <button class="btn btn-secondary" onclick="cancelEditSynopsis()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card recent-activity">
                    <div class="card-header">
                        <h3>‚è∞ Recent Activity</h3>
                    </div>
                    <div class="card-content">
                        <ul class="activity-list" id="activity-list">
                            <li class="activity-item">
                                <span class="activity-icon">üé≠</span>
                                <span class="activity-text">Campaign created - Waterdeep: Dragon Heist begins!</span>
                                <span class="activity-time">Just now</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Party Section -->
        <section id="party" class="content-section">
            <div class="section-header">
                <h2>Characters</h2>
                <p class="section-subtitle">Heroes & Allies of Waterdeep</p>
                <button class="btn btn-primary" onclick="openCharacterModal()">+ Add Character</button>
            </div>

            <!-- Party Stats -->
            <div class="card quick-stats">
                <div class="card-header">
                    <h3>üìä Party Stats</h3>
                </div>
                <div class="card-content">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-number">5</span>
                            <span class="stat-label">Players</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="party-level">1</span>
                            <span class="stat-label">Party Level</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="total-gold">0</span>
                            <span class="stat-label">Gold (Party)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="sessions-played">0</span>
                            <span class="stat-label">Sessions</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Character Filters -->
            <div class="character-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="pc">Player Characters</button>
                <button class="filter-btn" data-filter="npc">NPCs</button>
            </div>

            <div class="party-grid" id="party-grid">
                <!-- Characters will be rendered dynamically -->
            </div>

            <!-- DM Card -->
            <div class="dm-section">
                <div class="dm-card">
                    <div class="dm-portrait">
                        <div class="dm-icon">üëë</div>
                    </div>
                    <div class="dm-info">
                        <h3>Dungeon Master</h3>
                        <p class="dm-name" contenteditable="true">The Architect of Fate</p>
                        <p class="dm-tagline" contenteditable="true">"In Waterdeep, even the cobblestones have secrets..."</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PC Tales Section -->
        <section id="pc-tales" class="content-section">
            <div class="section-header">
                <h2>PC Tales!</h2>
                <p class="section-subtitle">Player Chronicles & Party Resources</p>
                <button class="btn btn-primary" onclick="openTaleModal()">+ New Entry</button>
            </div>

            <div class="pc-tales-container">
                <div class="tales-tabs">
                    <button class="tab-btn active" data-tab="journals">
                        <span class="tab-icon">üìî</span> IC Logs & Journals
                    </button>
                    <button class="tab-btn" data-tab="resources">
                        <span class="tab-icon">üí∞</span> Shared Resources
                    </button>
                    <button class="tab-btn" data-tab="relationships">
                        <span class="tab-icon">üí¨</span> Relationship Snippets
                    </button>
                    <button class="tab-btn" data-tab="backgrounds">
                        <span class="tab-icon">üìú</span> Background Stories
                    </button>
                    <button class="tab-btn" data-tab="misc">
                        <span class="tab-icon">üì¶</span> Other
                    </button>
                </div>

                <!-- IC Logs & Journals Tab -->
                <div class="tab-content active" id="journals">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="openTaleModal('journal')">+ Add Journal Entry</button>
                    </div>
                    <div class="tales-grid" id="journals-grid">
                        <!-- Journals rendered dynamically -->
                    </div>
                </div>

                <!-- Shared Resources Tab -->
                <div class="tab-content" id="resources">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="openResourceModal()">+ Add Resource</button>
                    </div>
                    <div class="resources-grid" id="resources-grid">
                        <div class="resource-card">
                            <div class="resource-header">
                                <h4>üí∞ Party Gold</h4>
                                <button class="btn btn-small" onclick="editResource('gold')">Edit</button>
                            </div>
                            <div class="resource-value" id="party-gold-resource">0 gp</div>
                            <div class="resource-notes" id="gold-notes">Track party treasury here</div>
                        </div>
                        <div class="resource-card">
                            <div class="resource-header">
                                <h4>üéí Party Inventory</h4>
                                <button class="btn btn-small" onclick="editResource('inventory')">Edit</button>
                            </div>
                            <div class="resource-content" id="party-inventory">
                                <p><em>No shared items yet</em></p>
                            </div>
                        </div>
                        <div class="resource-card">
                            <div class="resource-header">
                                <h4>üè† Party Property</h4>
                                <button class="btn btn-small" onclick="editResource('property')">Edit</button>
                            </div>
                            <div class="resource-content" id="party-property">
                                <p><em>No properties acquired</em></p>
                            </div>
                        </div>
                        <div class="resource-card">
                            <div class="resource-header">
                                <h4>üë• Contacts & Allies</h4>
                                <button class="btn btn-small" onclick="editResource('contacts')">Edit</button>
                            </div>
                            <div class="resource-content" id="party-contacts">
                                <p><em>No notable contacts yet</em></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relationship Snippets Tab -->
                <div class="tab-content" id="relationships">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="openTaleModal('relationship')">+ Add Snippet</button>
                    </div>
                    <div class="tales-grid" id="relationships-grid">
                        <!-- Relationship snippets rendered dynamically -->
                    </div>
                </div>

                <!-- Background Stories Tab -->
                <div class="tab-content" id="backgrounds">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="openTaleModal('background')">+ Add Background Story</button>
                    </div>
                    <div class="tales-grid" id="backgrounds-grid">
                        <!-- Background stories rendered dynamically -->
                    </div>
                </div>

                <!-- Other Tab -->
                <div class="tab-content" id="misc">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="openTaleModal('misc')">+ Add Entry</button>
                    </div>
                    <div class="misc-list" id="misc-list">
                        <!-- Misc items rendered dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Campaign Notes Section -->
        <section id="campaign-notes" class="content-section">
            <div class="section-header">
                <h2>Campaign Notes</h2>
                <p class="section-subtitle">Behind the Screen</p>
            </div>

            <div class="campaign-notes-container">
                <div class="notes-tabs">
                    <button class="tab-btn active" data-tab="ooc-notes">
                        <span class="tab-icon">üìã</span> OOC Notes
                    </button>
                    <button class="tab-btn" data-tab="dm-notes-tab">
                        <span class="tab-icon">üé≤</span> DM Notes
                    </button>
                    <button class="tab-btn" data-tab="session-summaries">
                        <span class="tab-icon">üìù</span> Session Summaries
                    </button>
                    <button class="tab-btn" data-tab="npcs">
                        <span class="tab-icon">üë•</span> NPCs
                    </button>
                    <button class="tab-btn" data-tab="locations">
                        <span class="tab-icon">üó∫Ô∏è</span> Locations
                    </button>
                    <button class="tab-btn" data-tab="quests">
                        <span class="tab-icon">‚öîÔ∏è</span> Quests
                    </button>
                </div>

                <!-- OOC Notes Tab -->
                <div class="tab-content active" id="ooc-notes">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="addOOCNote()">+ Add OOC Note</button>
                    </div>
                    <div class="notes-list" id="ooc-notes-list">
                        <div class="note-card ooc">
                            <div class="note-header">
                                <h4>Session Planning - Chapter 1</h4>
                                <span class="note-date">Pre-Session</span>
                            </div>
                            <div class="note-content">
                                <p><strong>Key Beats:</strong></p>
                                <ul>
                                    <li>Introduce the party at the Yawning Portal</li>
                                    <li>Troll attack from the well</li>
                                    <li>Volo's proposition</li>
                                    <li>Investigation of Floon's disappearance</li>
                                </ul>
                                <p><strong>Potential Hooks:</strong></p>
                                <ul>
                                    <li>Connect to Tharion's missing parents subplot</li>
                                    <li>Seraphina might know someone in the Dock Ward</li>
                                </ul>
                            </div>
                            <div class="note-tags">
                                <span class="tag">planning</span>
                                <span class="tag">chapter 1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DM Notes Tab -->
                <div class="tab-content" id="dm-notes-tab">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="addDMNote()">+ Add DM Note</button>
                    </div>
                    <div class="notes-list" id="dm-notes-list">
                        <div class="note-card dm">
                            <div class="note-header">
                                <h4>The Yawning Portal Atmosphere</h4>
                                <span class="note-date">Session 1</span>
                            </div>
                            <div class="note-content">
                                <p><em>"The common room buzzes with the usual crowd - adventurers nursing ales and wounds alike, merchants conducting quiet business in shadowed corners, and the ever-present rumble of Durnan's gravelly voice keeping order. The great well in the center of the room - the entrance to Undermountain itself - seems to pulse with an almost hungry energy tonight..."</em></p>
                            </div>
                            <div class="note-tags">
                                <span class="tag">atmosphere</span>
                                <span class="tag">yawning portal</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Summaries Tab -->
                <div class="tab-content" id="session-summaries">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="addSessionSummary()">+ Add Session Summary</button>
                    </div>
                    <div class="notes-list" id="session-summaries-list">
                        <!-- Session summaries will be rendered dynamically -->
                    </div>
                </div>

                <!-- NPCs Tab -->
                <div class="tab-content" id="npcs">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="addNPC()">+ Add NPC</button>
                    </div>
                    <div class="npc-grid" id="npc-grid">
                        <!-- NPCs rendered dynamically by JavaScript -->
                    </div>
                </div>

                <!-- Locations Tab -->
                <div class="tab-content" id="locations">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="addLocation()">+ Add Location</button>
                    </div>
                    <div class="locations-list" id="locations-list">
                        <!-- Locations rendered dynamically by JavaScript -->
                    </div>
                </div>

                <!-- Quests Tab -->
                <div class="tab-content" id="quests">
                    <div class="notes-toolbar">
                        <button class="btn btn-primary" onclick="addQuest()">+ Add Quest</button>
                    </div>
                    <div class="quests-list" id="quests-list">
                        <div class="quest-card main">
                            <div class="quest-status-indicator active"></div>
                            <div class="quest-info">
                                <div class="quest-header">
                                    <h4>Find Floon Blagmaar</h4>
                                    <span class="quest-type main-quest">Main Quest</span>
                                </div>
                                <p class="quest-giver">Quest Giver: Volothamp Geddarm</p>
                                <p class="quest-description">Volo's friend Floon has gone missing after a night out in the Dock Ward. Find him and return him safely.</p>
                                <div class="quest-rewards">
                                    <span class="reward">üí∞ 100 gp (promised)</span>
                                    <span class="reward">üè† A "property" in Waterdeep</span>
                                </div>
                                <div class="quest-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 0%"></div>
                                    </div>
                                    <span class="progress-text">Not Started</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Initiative Tracker Section -->
        <section id="initiative" class="content-section">
            <div class="section-header">
                <h2>Initiative Tracker</h2>
                <p class="section-subtitle">Combat Management</p>
            </div>

            <div class="initiative-container">
                <div class="initiative-controls">
                    <button class="btn btn-primary" onclick="startNewEncounter()">üó°Ô∏è New Encounter</button>
                    <button class="btn btn-secondary" onclick="sortByInitiative()">‚¨ÜÔ∏è Sort by Initiative</button>
                    <button class="btn btn-secondary" onclick="nextTurn()">‚û°Ô∏è Next Turn</button>
                    <button class="btn btn-danger" onclick="clearEncounter()">üóëÔ∏è Clear</button>
                </div>

                <div class="initiative-layout">
                    <!-- PC Selection Panel -->
                    <div class="initiative-panel pcs-panel">
                        <div class="panel-header">
                            <h3>‚öîÔ∏è Player Characters</h3>
                            <p class="panel-hint">Toggle PCs for this session</p>
                        </div>
                        <div class="pc-selection" id="pc-selection">
                            <!-- PCs will be loaded from Party tab -->
                        </div>
                    </div>

                    <!-- Initiative Order -->
                    <div class="initiative-panel order-panel">
                        <div class="panel-header">
                            <h3>‚ö° Initiative Order</h3>
                            <span class="round-counter" id="round-counter">Round 1</span>
                        </div>
                        <div class="initiative-list" id="initiative-list">
                            <div class="initiative-empty">
                                <p>No combatants yet. Add PCs and NPCs to begin!</p>
                            </div>
                        </div>
                    </div>

                    <!-- NPC Addition Panel -->
                    <div class="initiative-panel npc-panel">
                        <div class="panel-header">
                            <h3>üëπ Add NPC to Combat</h3>
                        </div>
                        <form id="combat-npc-form" class="combat-npc-form">
                            <div class="form-group">
                                <label for="combat-npc-name">Name</label>
                                <input type="text" id="combat-npc-name" placeholder="e.g., Goblin 1, Bandit Leader">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="combat-npc-init">Initiative</label>
                                    <input type="number" id="combat-npc-init" placeholder="Roll" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="combat-npc-hp">HP</label>
                                    <input type="number" id="combat-npc-hp" placeholder="Max HP" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="combat-npc-ac">AC</label>
                                    <input type="number" id="combat-npc-ac" placeholder="AC" min="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="combat-npc-saves">Saving Throws</label>
                                <input type="text" id="combat-npc-saves" placeholder="e.g., STR +3, DEX +2, CON +1">
                            </div>
                            <div class="form-group">
                                <label for="combat-npc-skills">Skills</label>
                                <input type="text" id="combat-npc-skills" placeholder="e.g., Stealth +4, Perception +2">
                            </div>
                            <div class="form-group">
                                <label for="combat-npc-spells">Spells/Abilities</label>
                                <textarea id="combat-npc-spells" rows="2" placeholder="e.g., Fireball (3/day), Multiattack"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="combat-npc-notes">Notes</label>
                                <textarea id="combat-npc-notes" rows="2" placeholder="Resistances, vulnerabilities, tactics..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Add to Combat</button>
                        </form>
                    </div>
                </div>

                <!-- Combatant Details (shows when selecting a combatant) -->
                <div class="combatant-details" id="combatant-details" style="display: none;">
                    <div class="details-header">
                        <h3 id="detail-name">Combatant Name</h3>
                        <button class="btn btn-small" onclick="closeCombatantDetails()">√ó</button>
                    </div>
                    <div class="details-content">
                        <div class="details-stats">
                            <div class="stat-box">
                                <span class="stat-label">HP</span>
                                <div class="hp-control">
                                    <button onclick="adjustHP(-1)">-</button>
                                    <span id="detail-hp">0/0</span>
                                    <button onclick="adjustHP(1)">+</button>
                                </div>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">AC</span>
                                <span id="detail-ac">10</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">Init</span>
                                <span id="detail-init">0</span>
                            </div>
                        </div>
                        <div class="details-section">
                            <h4>Saving Throws</h4>
                            <p id="detail-saves">-</p>
                        </div>
                        <div class="details-section">
                            <h4>Skills</h4>
                            <p id="detail-skills">-</p>
                        </div>
                        <div class="details-section">
                            <h4>Spells/Abilities</h4>
                            <p id="detail-spells">-</p>
                        </div>
                        <div class="details-section">
                            <h4>Notes</h4>
                            <p id="detail-notes">-</p>
                        </div>
                        <div class="details-actions">
                            <button class="btn btn-danger" onclick="removeCombatant()">Remove from Combat</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Rules Section -->
        <section id="rules" class="content-section">
            <div class="section-header">
                <h2>House Rules & References</h2>
                <p class="section-subtitle">D&D 2024 Edition Rules & Campaign-Specific Modifications</p>
            </div>

            <div class="rules-container">
                <div class="rules-sidebar">
                    <nav class="rules-nav">
                        <button class="rules-nav-btn active" data-rule="house-rules">üè† House Rules</button>
                        <button class="rules-nav-btn" data-rule="combat">‚öîÔ∏è Combat</button>
                        <button class="rules-nav-btn" data-rule="magic">‚ú® Magic</button>
                        <button class="rules-nav-btn" data-rule="exploration">üó∫Ô∏è Exploration</button>
                        <button class="rules-nav-btn" data-rule="social">üí¨ Social</button>
                        <button class="rules-nav-btn" data-rule="resting">üõèÔ∏è Resting</button>
                        <button class="rules-nav-btn" data-rule="death">üíÄ Death & Dying</button>
                        <button class="rules-nav-btn" data-rule="homebrew">üîß Homebrew</button>
                    </nav>
                </div>

                <div class="rules-content">
                    <!-- House Rules -->
                    <div class="rule-section active" id="rule-house-rules">
                        <div class="rule-header">
                            <h3>üè† House Rules</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('house-rules')">Edit</button>
                        </div>
                        <div class="rule-content" id="house-rules-content">
                            <div class="rule-display">
                                <h4>General House Rules</h4>
                                <ul>
                                    <li><strong>Rule of Cool:</strong> If something is dramatically appropriate and awesome, the DM may allow it with appropriate checks.</li>
                                    <li><strong>Critical Hits:</strong> On a natural 20, roll damage dice twice (2024 rules) AND add maximum damage from one set.</li>
                                    <li><strong>Inspiration:</strong> Players can hold up to 2 Inspiration points. Inspiration can be given to other players.</li>
                                    <li><strong>Flanking:</strong> Grants +2 to attack rolls instead of advantage (to preserve the value of class features).</li>
                                    <li><strong>Potions:</strong> Drinking a potion is a bonus action. Administering to another is an action.</li>
                                </ul>

                                <h4>Table Etiquette</h4>
                                <ul>
                                    <li>Phones on silent during sessions</li>
                                    <li>No PvP without mutual consent</li>
                                    <li>The DM's ruling is final (but can be discussed after session)</li>
                                    <li>X-Card system is in effect - anyone can call X to skip content</li>
                                </ul>

                                <h4>Attendance</h4>
                                <ul>
                                    <li>Please notify at least 24 hours in advance if you can't make it</li>
                                    <li>Sessions proceed with 3+ players</li>
                                    <li>Absent characters are "in the background" unless story demands otherwise</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="house-rules-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('house-rules')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('house-rules')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combat Rules -->
                    <div class="rule-section" id="rule-combat">
                        <div class="rule-header">
                            <h3>‚öîÔ∏è Combat Rules (2024 Edition)</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('combat')">Edit</button>
                        </div>
                        <div class="rule-content" id="combat-content">
                            <div class="rule-display">
                                <h4>Initiative</h4>
                                <ul>
                                    <li>Roll d20 + Dexterity modifier + any bonuses</li>
                                    <li>Ties go to higher Dexterity score, then players before monsters</li>
                                </ul>

                                <h4>Actions in Combat</h4>
                                <ul>
                                    <li><strong>Action:</strong> Attack, Cast a Spell, Dash, Disengage, Dodge, Help, Hide, Ready, Search, Use an Object</li>
                                    <li><strong>Bonus Action:</strong> Only if a feature specifically grants one</li>
                                    <li><strong>Reaction:</strong> Opportunity Attack, Readied Action, or specific features</li>
                                    <li><strong>Free Object Interaction:</strong> One per turn (draw weapon, open door, etc.)</li>
                                </ul>

                                <h4>2024 Changes</h4>
                                <ul>
                                    <li><strong>Weapon Mastery:</strong> Each weapon has a mastery property that martial characters can use</li>
                                    <li><strong>Two-Weapon Fighting:</strong> Now part of the Attack action, not a bonus action</li>
                                    <li><strong>Grapple/Shove:</strong> Can replace one attack, uses Athletics vs. target's save</li>
                                </ul>

                                <h4>Conditions Quick Reference</h4>
                                <ul>
                                    <li><strong>Blinded:</strong> Auto-fail sight checks, disadvantage on attacks, attacks against have advantage</li>
                                    <li><strong>Frightened:</strong> Disadvantage while source visible, can't move closer</li>
                                    <li><strong>Prone:</strong> Disadvantage on attacks, melee attacks have advantage, ranged have disadvantage</li>
                                    <li><strong>Stunned:</strong> Incapacitated, auto-fail Str/Dex saves, attacks have advantage</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="combat-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('combat')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('combat')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Magic Rules -->
                    <div class="rule-section" id="rule-magic">
                        <div class="rule-header">
                            <h3>‚ú® Magic Rules</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('magic')">Edit</button>
                        </div>
                        <div class="rule-content" id="magic-content">
                            <div class="rule-display">
                                <h4>Spellcasting Basics</h4>
                                <ul>
                                    <li><strong>Spell Slots:</strong> Expended on casting, recovered on rest</li>
                                    <li><strong>Concentration:</strong> Only one concentration spell at a time. Con save DC 10 or half damage taken.</li>
                                    <li><strong>Components:</strong> V (verbal), S (somatic), M (material)</li>
                                </ul>

                                <h4>2024 Changes</h4>
                                <ul>
                                    <li><strong>Spell Lists:</strong> Now organized by Arcane, Divine, and Primal</li>
                                    <li><strong>Cantrip Scaling:</strong> Based on character level, not class level</li>
                                    <li><strong>Ritual Casting:</strong> Added 10 minutes, doesn't expend spell slot</li>
                                </ul>

                                <h4>House Rule Modifications</h4>
                                <ul>
                                    <li><strong>Identify:</strong> Short rest can identify most items; Identify reveals curses</li>
                                    <li><strong>Spell Components:</strong> Component pouch/focus covers all non-consumed, non-costly materials</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="magic-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('magic')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('magic')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exploration Rules -->
                    <div class="rule-section" id="rule-exploration">
                        <div class="rule-header">
                            <h3>üó∫Ô∏è Exploration Rules</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('exploration')">Edit</button>
                        </div>
                        <div class="rule-content" id="exploration-content">
                            <div class="rule-display">
                                <h4>Travel Pace</h4>
                                <ul>
                                    <li><strong>Fast:</strong> 400 feet/minute, 4 mph, 30 miles/day (-5 passive Perception)</li>
                                    <li><strong>Normal:</strong> 300 feet/minute, 3 mph, 24 miles/day</li>
                                    <li><strong>Slow:</strong> 200 feet/minute, 2 mph, 18 miles/day (can stealth)</li>
                                </ul>

                                <h4>Waterdeep Navigation</h4>
                                <ul>
                                    <li>Getting around Waterdeep doesn't require checks for known locations</li>
                                    <li>Finding specific addresses/hidden locations may require Investigation or asking around</li>
                                    <li>The Watch patrols most wards; Dock Ward has less presence</li>
                                </ul>

                                <h4>Skill Challenges</h4>
                                <ul>
                                    <li>Complex tasks may use skill challenges: accumulate successes before failures</li>
                                    <li>Different skills can contribute - creativity encouraged!</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="exploration-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('exploration')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('exploration')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Social Rules -->
                    <div class="rule-section" id="rule-social">
                        <div class="rule-header">
                            <h3>üí¨ Social Interaction</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('social')">Edit</button>
                        </div>
                        <div class="rule-content" id="social-content">
                            <div class="rule-display">
                                <h4>NPC Attitudes</h4>
                                <ul>
                                    <li><strong>Hostile:</strong> Works against you, may attack</li>
                                    <li><strong>Unfriendly:</strong> Won't help, may hinder</li>
                                    <li><strong>Indifferent:</strong> Neutral, will help for fair payment</li>
                                    <li><strong>Friendly:</strong> Will help within reason</li>
                                    <li><strong>Helpful:</strong> Will take risks to help</li>
                                </ul>

                                <h4>Social Skills</h4>
                                <ul>
                                    <li><strong>Persuasion:</strong> Good faith attempts to convince</li>
                                    <li><strong>Deception:</strong> Lies and misdirection</li>
                                    <li><strong>Intimidation:</strong> Threats and coercion</li>
                                    <li><strong>Insight:</strong> Reading motives and lies</li>
                                </ul>

                                <h4>Waterdeep Social Notes</h4>
                                <ul>
                                    <li>Noble houses have complex relationships - tread carefully</li>
                                    <li>The Code Legal governs behavior - violence has consequences</li>
                                    <li>Factions offer opportunities and obligations</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="social-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('social')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('social')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resting Rules -->
                    <div class="rule-section" id="rule-resting">
                        <div class="rule-header">
                            <h3>üõèÔ∏è Resting Rules</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('resting')">Edit</button>
                        </div>
                        <div class="rule-content" id="resting-content">
                            <div class="rule-display">
                                <h4>Short Rest</h4>
                                <ul>
                                    <li>1 hour of downtime</li>
                                    <li>Spend Hit Dice to heal</li>
                                    <li>Some features recharge</li>
                                </ul>

                                <h4>Long Rest</h4>
                                <ul>
                                    <li>8 hours (6 sleeping, 2 light activity)</li>
                                    <li>Regain all HP and half Hit Dice (minimum 1)</li>
                                    <li>Regain all spell slots and most features</li>
                                    <li>Only one per 24 hours</li>
                                </ul>

                                <h4>Waterdeep Lodging</h4>
                                <ul>
                                    <li><strong>Squalid:</strong> 1 sp/night - Dock Ward flophouses</li>
                                    <li><strong>Poor:</strong> 2 sp/night - Basic inns</li>
                                    <li><strong>Modest:</strong> 5 sp/night - Decent rooms</li>
                                    <li><strong>Comfortable:</strong> 8 sp/night - Good inns like the Yawning Portal</li>
                                    <li><strong>Wealthy:</strong> 2 gp/night - Fine establishments</li>
                                    <li><strong>Aristocratic:</strong> 4+ gp/night - Luxury accommodations</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="resting-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('resting')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('resting')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Death Rules -->
                    <div class="rule-section" id="rule-death">
                        <div class="rule-header">
                            <h3>üíÄ Death & Dying</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('death')">Edit</button>
                        </div>
                        <div class="rule-content" id="death-content">
                            <div class="rule-display">
                                <h4>Dropping to 0 HP</h4>
                                <ul>
                                    <li>Fall unconscious and begin making death saves</li>
                                    <li>Stable at 3 successes, dead at 3 failures</li>
                                    <li>Natural 20: regain 1 HP</li>
                                    <li>Natural 1: counts as 2 failures</li>
                                    <li>Taking damage while at 0: automatic failure (crit = 2 failures)</li>
                                </ul>

                                <h4>Instant Death</h4>
                                <ul>
                                    <li>Damage exceeding current HP + max HP = instant death</li>
                                    <li>Certain effects (Power Word Kill, Disintegrate at 0 HP)</li>
                                </ul>

                                <h4>Resurrection</h4>
                                <ul>
                                    <li>Revivify (3rd): 1 minute, 300gp diamonds</li>
                                    <li>Raise Dead (5th): 10 days, 500gp diamonds</li>
                                    <li>Resurrection (7th): 100 years, 1000gp diamonds</li>
                                    <li>True Resurrection (9th): 200 years, 25000gp diamonds</li>
                                </ul>

                                <h4>House Rules</h4>
                                <ul>
                                    <li>Death saves are rolled privately by the DM to increase tension</li>
                                    <li>Resurrection may have story consequences in Waterdeep</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="death-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('death')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('death')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Homebrew Rules -->
                    <div class="rule-section" id="rule-homebrew">
                        <div class="rule-header">
                            <h3>üîß Homebrew & Campaign-Specific</h3>
                            <button class="btn btn-small" onclick="toggleEditRules('homebrew')">Edit</button>
                        </div>
                        <div class="rule-content" id="homebrew-content">
                            <div class="rule-display">
                                <h4>Waterdeep-Specific Rules</h4>
                                <ul>
                                    <li><strong>The Code Legal:</strong> Waterdeep has strict laws. Murder, theft, and assault are punished severely.</li>
                                    <li><strong>Masked Lords:</strong> The city's rulers are anonymous - never assume you know who they are.</li>
                                    <li><strong>Walking Statues:</strong> In emergencies, massive constructs may activate to defend the city.</li>
                                </ul>

                                <h4>Faction Benefits</h4>
                                <p>Joining factions provides benefits based on renown:</p>
                                <ul>
                                    <li><strong>Harpers:</strong> Information network, safe houses</li>
                                    <li><strong>Order of the Gauntlet:</strong> Martial support, healing</li>
                                    <li><strong>Emerald Enclave:</strong> Nature magic, animal companions</li>
                                    <li><strong>Lords' Alliance:</strong> Political connections, resources</li>
                                    <li><strong>Zhentarim:</strong> Black market access, muscle for hire</li>
                                </ul>

                                <h4>Downtime Activities</h4>
                                <ul>
                                    <li><strong>Work:</strong> Earn modest living expenses</li>
                                    <li><strong>Train:</strong> Learn new tool/language (250 days, 1gp/day)</li>
                                    <li><strong>Research:</strong> Learn about topics relevant to the campaign</li>
                                    <li><strong>Carousing:</strong> Make contacts (and potentially trouble)</li>
                                </ul>

                                <h4>Party Decisions Log</h4>
                                <p><em>Record significant rule discussions and decisions here:</em></p>
                                <ul>
                                    <li>No entries yet - add decisions as the campaign progresses!</li>
                                </ul>
                            </div>
                            <div class="rule-edit hidden">
                                <div class="rich-editor">
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                        <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                        <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                        <span class="toolbar-divider"></span>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                    </div>
                                    <div class="editor-content rule-editor-content" id="homebrew-edit" contenteditable="true"></div>
                                </div>
                                <div class="edit-actions">
                                    <button class="btn btn-primary" onclick="saveRules('homebrew')">Save</button>
                                    <button class="btn btn-secondary" onclick="cancelEditRules('homebrew')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gallery Section -->
        <section id="gallery" class="content-section">
            <div class="section-header">
                <h2>Campaign Gallery</h2>
                <p class="section-subtitle">Visual Chronicles of Waterdeep</p>
                <button class="btn btn-primary" onclick="openImageUpload()">+ Add Image</button>
            </div>

            <div class="gallery-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="maps">Maps</button>
                <button class="filter-btn" data-filter="characters">Characters</button>
                <button class="filter-btn" data-filter="locations">Locations</button>
                <button class="filter-btn" data-filter="items">Items</button>
                <button class="filter-btn" data-filter="scenes">Scenes</button>
            </div>

            <div class="gallery-grid" id="gallery-grid">
                <!-- Gallery items rendered dynamically by JavaScript -->
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Tale Modal (PC Tales) -->
    <div id="tale-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="tale-modal-title">New Entry</h3>
                <button class="modal-close" onclick="closeModal('tale-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tale-form">
                    <input type="hidden" id="tale-edit-id">
                    <div class="form-group">
                        <label for="tale-title-input">Title</label>
                        <input type="text" id="tale-title-input" required>
                    </div>
                    <div class="form-group">
                        <label for="tale-type-select">Type</label>
                        <select id="tale-type-select">
                            <option value="journal">IC Log / Journal Entry</option>
                            <option value="relationship">Relationship Snippet</option>
                            <option value="background">Background Story</option>
                            <option value="misc">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tale-author-input">Author / Source</label>
                        <input type="text" id="tale-author-input" placeholder="Character name or source">
                    </div>
                    <div class="form-group">
                        <label for="tale-session-input">Session / Date</label>
                        <input type="text" id="tale-session-input" placeholder="e.g., Session 1, Day 3">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <div class="rich-editor" id="tale-content-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('formatBlock', 'h3')" title="Heading">H</button>
                                <button type="button" onclick="formatText('formatBlock', 'blockquote')" title="Quote">"</button>
                            </div>
                            <div class="editor-content" id="tale-content-input" contenteditable="true" data-placeholder="Write your entry here..."></div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Entry</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('tale-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Resource Edit Modal -->
    <div id="resource-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="resource-modal-title">Edit Resource</h3>
                <button class="modal-close" onclick="closeModal('resource-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="resource-form">
                    <input type="hidden" id="resource-type-input">
                    <div class="form-group" id="resource-value-group" style="display: none;">
                        <label for="resource-value-input">Value</label>
                        <input type="number" id="resource-value-input" min="0">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <div class="rich-editor" id="resource-content-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                            </div>
                            <div class="editor-content" id="resource-content-input" contenteditable="true" data-placeholder="Update the resource details..."></div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('resource-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Session Summary Modal -->
    <div id="session-summary-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>New Session Summary</h3>
                <button class="modal-close" onclick="closeModal('session-summary-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="session-summary-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="summary-session-input">Session Number</label>
                            <input type="number" id="summary-session-input" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="summary-date-input">Date Played</label>
                            <input type="date" id="summary-date-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="summary-title-input">Session Title</label>
                        <input type="text" id="summary-title-input" placeholder="e.g., The Ambush on the High Road">
                    </div>
                    <div class="form-group">
                        <label>Summary</label>
                        <div class="rich-editor" id="summary-content-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                            </div>
                            <div class="editor-content" id="summary-content-input" contenteditable="true" data-placeholder="What happened this session?"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="summary-xp-input">XP Earned</label>
                        <input type="number" id="summary-xp-input" min="0" placeholder="0">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Summary</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('session-summary-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="note-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="note-modal-title">New Note</h3>
                <button class="modal-close" onclick="closeModal('note-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="note-form">
                    <input type="hidden" id="note-type-hidden">
                    <input type="hidden" id="note-edit-id" value="">
                    <div class="form-group">
                        <label for="note-title-input">Title</label>
                        <input type="text" id="note-title-input" required>
                    </div>
                    <div class="form-group">
                        <label for="note-session-input">Session/Date</label>
                        <input type="text" id="note-session-input" placeholder="e.g., Session 1, Pre-Session">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <div class="rich-editor" id="note-content-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                            </div>
                            <div class="editor-content" id="note-content-input" contenteditable="true" data-placeholder="Write your notes here..."></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="note-tags-input">Tags (comma separated)</label>
                        <input type="text" id="note-tags-input" placeholder="e.g., planning, chapter 1">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Note</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('note-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- NPC Modal -->
    <div id="npc-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add NPC</h3>
                <button class="modal-close" onclick="closeModal('npc-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="npc-form">
                    <div class="form-group">
                        <label for="npc-name-input">Name</label>
                        <input type="text" id="npc-name-input" required>
                    </div>
                    <div class="form-group">
                        <label for="npc-role-input">Role/Title</label>
                        <input type="text" id="npc-role-input" placeholder="e.g., Tavern Owner, City Guard">
                    </div>
                    <div class="form-group">
                        <label for="npc-image-input">Image URL</label>
                        <input type="url" id="npc-image-input" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label for="npc-description-input">Description</label>
                        <textarea id="npc-description-input" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="npc-status-select">Status</label>
                        <select id="npc-status-select">
                            <option value="friendly">Friendly</option>
                            <option value="neutral">Neutral</option>
                            <option value="hostile">Hostile</option>
                            <option value="unknown">Unknown</option>
                            <option value="quest-giver">Quest Giver</option>
                            <option value="missing">Missing</option>
                            <option value="deceased">Deceased</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add NPC</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('npc-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Location</h3>
                <button class="modal-close" onclick="closeModal('location-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="location-form">
                    <div class="form-group">
                        <label for="location-name-input">Name</label>
                        <input type="text" id="location-name-input" required>
                    </div>
                    <div class="form-group">
                        <label for="location-ward-input">Ward/Area</label>
                        <input type="text" id="location-ward-input" placeholder="e.g., Castle Ward, Dock Ward">
                    </div>
                    <div class="form-group">
                        <label for="location-image-input">Image URL</label>
                        <input type="url" id="location-image-input" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label for="location-description-input">Description</label>
                        <textarea id="location-description-input" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="location-tags-input">Tags (comma separated)</label>
                        <input type="text" id="location-tags-input" placeholder="e.g., Tavern, Shop, Dangerous">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add Location</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('location-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quest Modal -->
    <div id="quest-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Quest</h3>
                <button class="modal-close" onclick="closeModal('quest-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="quest-form">
                    <div class="form-group">
                        <label for="quest-name-input">Quest Name</label>
                        <input type="text" id="quest-name-input" required>
                    </div>
                    <div class="form-group">
                        <label for="quest-type-select">Quest Type</label>
                        <select id="quest-type-select">
                            <option value="main">Main Quest</option>
                            <option value="side">Side Quest</option>
                            <option value="personal">Personal Quest</option>
                            <option value="faction">Faction Quest</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quest-giver-input">Quest Giver</label>
                        <input type="text" id="quest-giver-input">
                    </div>
                    <div class="form-group">
                        <label for="quest-description-input">Description</label>
                        <textarea id="quest-description-input" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="quest-rewards-input">Rewards</label>
                        <input type="text" id="quest-rewards-input" placeholder="e.g., 100 gp, Magic Sword">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add Quest</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('quest-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Story View Modal -->
    <div id="story-view-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="story-view-title">Story Title</h3>
                <button class="modal-close" onclick="closeModal('story-view-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="story-view-meta">
                    <span id="story-view-type" class="story-type-badge"></span>
                    <span id="story-view-author"></span>
                    <span id="story-view-date"></span>
                </div>
                <div id="story-view-content" class="story-view-content"></div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Image to Gallery</h3>
                <button class="modal-close" onclick="closeModal('image-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="image-form">
                    <div class="form-group">
                        <label for="image-url-input">Image URL</label>
                        <input type="url" id="image-url-input" required placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label for="image-title-input">Title</label>
                        <input type="text" id="image-title-input" required>
                    </div>
                    <div class="form-group">
                        <label for="image-description-input">Description</label>
                        <input type="text" id="image-description-input">
                    </div>
                    <div class="form-group">
                        <label for="image-category-select">Category</label>
                        <select id="image-category-select">
                            <option value="maps">Maps</option>
                            <option value="characters">Characters</option>
                            <option value="locations">Locations</option>
                            <option value="items">Items</option>
                            <option value="scenes">Scenes</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add to Gallery</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('image-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <img id="lightbox-img" src="" alt="">
        <div class="lightbox-caption">
            <h4 id="lightbox-title"></h4>
            <p id="lightbox-description"></p>
        </div>
    </div>

    <!-- Character Modal -->
    <div id="character-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="character-modal-title">Add Character</h3>
                <button class="modal-close" onclick="closeModal('character-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="character-form">
                    <input type="hidden" id="character-edit-id">

                    <!-- PC/NPC Toggle -->
                    <div class="form-group">
                        <label>Character Type</label>
                        <div class="type-toggle">
                            <button type="button" class="toggle-btn active" data-type="pc" onclick="setCharacterType('pc')">
                                <span class="toggle-icon">‚öîÔ∏è</span> Player Character (PC)
                            </button>
                            <button type="button" class="toggle-btn" data-type="npc" onclick="setCharacterType('npc')">
                                <span class="toggle-icon">üë§</span> Non-Player Character (NPC)
                            </button>
                        </div>
                        <input type="hidden" id="character-type-input" value="pc">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="character-name-input">Character Name</label>
                            <input type="text" id="character-name-input" required placeholder="e.g., Krak, Elara Moonshadow">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="character-species-input">Species</label>
                            <select id="character-species-input" required>
                                <option value="">Select Species...</option>
                                <option value="Aasimar">Aasimar</option>
                                <option value="Dragonborn">Dragonborn</option>
                                <option value="Dwarf">Dwarf</option>
                                <option value="Elf">Elf</option>
                                <option value="Gnome">Gnome</option>
                                <option value="Goliath">Goliath</option>
                                <option value="Halfling">Halfling</option>
                                <option value="Human">Human</option>
                                <option value="Orc">Orc</option>
                                <option value="Tiefling">Tiefling</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="character-class-input">Class</label>
                            <input type="text" id="character-class-input" placeholder="e.g. Fighter">
                        </div>
                        <div class="form-group">
                            <label for="character-subclass-input">Subclass</label>
                            <input type="text" id="character-subclass-input" placeholder="e.g. Champion">
                        </div>
                    </div>

                    <div class="form-row" id="player-name-row">
                        <div class="form-group">
                            <label for="character-player-input">Player Name</label>
                            <input type="text" id="character-player-input" placeholder="Who plays this character?">
                        </div>
                        <div class="form-group">
                            <label for="character-level-input">Level</label>
                            <input type="number" id="character-level-input" min="1" max="20" value="1">
                        </div>
                        <div class="form-group">
                            <label for="character-ac-input">AC</label>
                            <input type="number" id="character-ac-input" min="1" value="10">
                        </div>
                        <div class="form-group">
                            <label for="character-init-input">Initiative</label>
                            <input type="text" id="character-init-input" placeholder="+2" value="+0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="character-deceased-input">
                            Deceased
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Portrait Image</label>
                        <div class="portrait-input-options">
                            <div class="portrait-tabs">
                                <button type="button" class="portrait-tab active" onclick="switchPortraitTab('url')">URL</button>
                                <button type="button" class="portrait-tab" onclick="switchPortraitTab('upload')">Upload</button>
                            </div>
                            <div class="portrait-tab-content active" id="portrait-url-tab">
                                <input type="url" id="character-portrait-input" placeholder="https://... (leave blank for default)">
                            </div>
                            <div class="portrait-tab-content" id="portrait-upload-tab">
                                <div class="portrait-upload-zone" id="portrait-upload-zone">
                                    <span class="portrait-upload-icon">üì∑</span>
                                    <span>Click or drag image here</span>
                                    <input type="file" id="portrait-file-input" accept="image/*" hidden>
                                </div>
                            </div>
                            <div class="portrait-preview" id="portrait-preview" style="display:none;">
                                <img id="portrait-preview-img" src="" alt="Preview">
                                <button type="button" class="btn btn-small btn-danger" onclick="clearPortraitUpload()">Remove</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Background & Notes</label>
                        <div class="rich-editor" id="character-background-editor">
                            <div class="editor-toolbar">
                                <button type="button" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                                <button type="button" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                                <button type="button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                <button type="button" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                <span class="toolbar-divider"></span>
                                <button type="button" onclick="formatText('formatBlock', 'h4')" title="Heading">H</button>
                                <button type="button" onclick="formatText('formatBlock', 'blockquote')" title="Quote">"</button>
                            </div>
                            <div class="editor-content" id="character-background-content" contenteditable="true" data-placeholder="Describe this character's background, personality, goals, and any important notes..."></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="delete-character-btn" onclick="deleteCharacter()" style="display: none;">Delete</button>
                        <div class="form-actions-right">
                            <button type="submit" class="btn btn-primary">Save Character</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('character-modal')">Cancel</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Campaign Edit Modal -->
    <div id="campaign-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Campaign Overview</h3>
                <button class="modal-close" onclick="closeModal('campaign-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="campaign-form">
                    <div class="form-group">
                        <label for="campaign-name-input">Campaign Name</label>
                        <input type="text" id="campaign-name-input" placeholder="e.g., Waterdeep: Dragon Heist">
                    </div>
                    <div class="form-group">
                        <label for="campaign-image-input">Campaign Image</label>
                        <input type="file" id="campaign-image-input" accept="image/*">
                        <div id="campaign-image-preview" style="margin-top: 0.5rem;"></div>
                        <button type="button" class="btn btn-small btn-secondary" id="campaign-image-remove-btn" style="display:none; margin-top: 0.5rem;" onclick="removeCampaignImage()">Remove Image</button>
                    </div>
                    <div class="form-group">
                        <label for="campaign-chapter-input">Current Chapter</label>
                        <input type="text" id="campaign-chapter-input" placeholder="e.g., Chapter 1: Along the High Road">
                    </div>
                    <div class="form-group">
                        <label for="campaign-session-input">Session Number</label>
                        <input type="number" id="campaign-session-input" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="campaign-location-input">Current Location</label>
                        <input type="text" id="campaign-location-input" placeholder="e.g., The High Road">
                    </div>
                    <div class="form-group">
                        <label for="campaign-level-input">Party Level</label>
                        <input type="number" id="campaign-level-input" min="1" max="20" value="1">
                    </div>
                    <div class="form-group">
                        <label for="campaign-xp-input">Current XP</label>
                        <input type="number" id="campaign-xp-input" min="0" value="0">
                        <span class="xp-hint" id="modal-xp-hint">XP needed for next level will be calculated automatically</span>
                    </div>
                    <div class="form-group">
                        <label for="campaign-gold-input">Party Gold</label>
                        <input type="number" id="campaign-gold-input" min="0" value="0">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('campaign-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (compat for no-bundler usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script src="app.js"></script>
</body>
</html>
